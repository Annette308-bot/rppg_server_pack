<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>rPPG Demo</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 720px; margin: 28px auto; padding: 0 16px; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 16px; margin: 14px 0; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    button { padding: 10px 14px; border-radius: 12px; border: 1px solid #111; background: #111; color: #fff; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    input, select { padding: 10px; border-radius: 12px; border: 1px solid #ccc; }
    .muted { color: #666; font-size: 0.95em; }
    .ok { color: #0a7; font-weight: 600; }
    .bad { color: #c20; font-weight: 600; }
    pre { white-space: pre-wrap; word-break: break-word; background: #f6f6f6; padding: 12px; border-radius: 12px; }
    .hrBig { font-size: 28px; font-weight: 700; }
    .pillBtn { background:#fff; color:#111; border:1px solid #111; }
    a { color: #0a58ca; }
    .divider { height: 1px; background: #eee; margin: 12px 0; }
  </style>
</head>
<body>
  <h2>rPPG Demo (Thesis Precomputed)</h2>
  <p class="muted">Upload a face/palm video → Analyze → get HR + SpO₂ + download CSV.</p>

  <div class="card">
    <div class="row" style="justify-content: space-between;">
      <div class="muted">Simple mode</div>
      <button id="settingsBtn" type="button" class="pillBtn" onclick="toggleSettings()">Settings</button>
    </div>

    <div id="settings" style="display:none; margin-top:12px;">
      <div class="row">
        <label>API URL:</label>
        <input id="apiBase" style="flex:1; min-width: 260px;" />
      </div>
      <p class="muted" style="margin:8px 0 0;">(Auto-filled. Change only if you use another server.)</p>
      <div class="divider"></div>
    </div>

    <div class="row" style="margin-top:12px;">
      <label>Video:</label>
      <input id="file" type="file" accept="video/*" />
    </div>

    <div class="row" style="margin-top:12px;">
      <label>Subject:</label>
      <input id="subject" value="S01" style="width:120px;" />

      <label>Condition:</label>
      <select id="condition">
        <option value="rest">rest</option>
        <option value="breath">breath</option>
        <option value="exercise">exercise</option>
      </select>

      <label>Modality:</label>
      <select id="modality">
        <option value="palm">palm</option>
        <option value="face">face</option>
      </select>

      <label>Min valid %:</label>
      <input id="minValid" type="number" value="50" style="width:90px;" />
    </div>

    <div class="row" style="margin-top:14px;">
      <button id="btn" onclick="run()">Analyze</button>
      <span id="status" class="muted"></span>
    </div>
  </div>

  <div class="card" id="resultCard" style="display:none;">
    <h3>Result</h3>
    <div id="summary"></div>

    <div class="row" style="margin-top:10px; gap:16px;">
      <a id="downloadLink" href="#" style="display:none;" download>Download CSV</a>
      <button id="toggleBtn" type="button" class="pillBtn" onclick="toggleDetails()" style="display:none;">
        Show details
      </button>
    </div>

    <div id="details" style="display:none; margin-top:12px;">
      <h4>Details (raw response)</h4>
      <pre id="raw"></pre>
    </div>

    <p class="muted">Note: On Render free tier, the service may sleep; first request can take ~30–60s.</p>
  </div>

<script>
function defaultApiBase() {
  // If served from http/https (Render), use same origin (no CORS issues).
  if (window.location.protocol === "http:" || window.location.protocol === "https:") {
    return window.location.origin;
  }
  // If opened as local file://, fallback to your Render URL.
  return "https://rppg-server-pack.onrender.com";
}

(function init() {
  const apiEl = document.getElementById("apiBase");
  if (apiEl) apiEl.value = defaultApiBase();
})();

function toggleSettings() {
  const s = document.getElementById("settings");
  const btn = document.getElementById("settingsBtn");
  const open = s.style.display !== "none";
  s.style.display = open ? "none" : "block";
  btn.textContent = open ? "Settings" : "Hide settings";
}

function toggleDetails() {
  const details = document.getElementById("details");
  const btn = document.getElementById("toggleBtn");
  const isOpen = details.style.display !== "none";
  details.style.display = isOpen ? "none" : "block";
  btn.textContent = isOpen ? "Show details" : "Hide details";
}

async function run() {
  const apiBaseEl = document.getElementById("apiBase");
  const apiBase = (apiBaseEl ? apiBaseEl.value : defaultApiBase()).replace(/\/+$/,"");

  const fileInput = document.getElementById("file");
  const btn = document.getElementById("btn");
  const status = document.getElementById("status");

  const subject = document.getElementById("subject").value || "S01";
  const condition = document.getElementById("condition").value;
  const modality = document.getElementById("modality").value;
  const minValid = document.getElementById("minValid").value || "50";

  if (!fileInput.files || fileInput.files.length === 0) {
    alert("Please choose a video file first.");
    return;
  }

  btn.disabled = true;
  status.textContent = "Uploading & analyzing…";

  try {
    const fd = new FormData();
    fd.append("file", fileInput.files[0]);
    fd.append("subject_id", subject);
    fd.append("condition", condition);
    fd.append("modality", modality);
    fd.append("method", "thesis_precomputed");
    fd.append("min_valid_pct", minValid);
    fd.append("save", "1");
    fd.append("timeout_sec", "240");

    const res = await fetch(`${apiBase}/upload_video`, { method: "POST", body: fd });
    const data = await res.json();

    document.getElementById("resultCard").style.display = "block";

    document.getElementById("details").style.display = "none";
    const toggleBtn = document.getElementById("toggleBtn");
    toggleBtn.style.display = "inline-block";
    toggleBtn.textContent = "Show details";
    document.getElementById("raw").textContent = JSON.stringify(data, null, 2);

    // HR
    const hr = data.hr_bpm;
    const trusted = data.trusted;
    const hrQuality = trusted ? `<span class="ok">Good</span>` : `<span class="bad">Low</span>`;
    const hrText = (hr === null || hr === undefined) ? "—" : Number(hr).toFixed(1);

    // SpO2
    const spo2 = data.spo2_pct;
    const spo2Trusted = data.spo2_trusted;
    const spo2Quality = spo2Trusted ? `<span class="ok">Good</span>` : `<span class="bad">Low</span>`;
    const spo2Text = (spo2 === null || spo2 === undefined) ? "—" : Number(spo2).toFixed(1);

    document.getElementById("summary").innerHTML = `
      <div class="row">
        <div><b>Stem:</b> ${data.stem || ""}</div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="hrBig">HR: ${hrText} bpm</div>
        <div style="font-size:18px;"><b>HR Quality:</b> ${hrQuality}</div>
      </div>

      <div class="row" style="margin-top:6px;">
        <div class="hrBig">SpO₂: ${spo2Text} %</div>
        <div style="font-size:18px;"><b>SpO₂ Quality:</b> ${spo2Quality}</div>
      </div>

      ${(!trusted ? `<p class="bad">Low HR signal quality. Try more light, less motion, and keep ROI steady.</p>` : ``)}
      ${(!spo2Trusted ? `<p class="bad">Low SpO₂ trend quality. Try stable lighting + reduce motion.</p>` : ``)}
    `;

    // Download link (show whenever server gives URL)
    const link = document.getElementById("downloadLink");
    const url = data?.saved?.download_url;
    if (url) {
      link.href = url;
      link.style.display = "inline-block";
      link.textContent = "Download CSV";
    } else {
      link.style.display = "none";
    }

    status.textContent = "Done.";
  } catch (e) {
    console.error(e);
    status.textContent = "Error. Check console.";
    alert("Request failed. If Render is sleeping, retry in 30–60 seconds.");
  } finally {
    btn.disabled = false;
  }
}
</script>
</body>
</html>
