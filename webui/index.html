<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>rPPG Demo</title>
  <style>
    body { font-family: Arial, sans-serif; background:#fff; color:#111; }
    .wrap { max-width: 920px; margin: 40px auto; padding: 0 16px; }
    h1 { font-size: 28px; margin: 0 0 8px; text-align:center; }
    .sub { text-align:center; color:#444; margin-bottom: 24px; }
    .card { border: 1px solid #ddd; border-radius: 18px; padding: 22px; margin: 14px 0; }
    .row { display:flex; gap:14px; flex-wrap:wrap; align-items:center; margin: 12px 0; }
    label { font-size: 13px; color:#333; display:block; margin-bottom:6px; }
    input, select { padding: 10px 12px; border-radius: 12px; border: 1px solid #ccc; font-size: 14px; }
    input[type="file"]{ padding: 8px; }
    .btn { background:#111; color:#fff; border:none; padding: 12px 18px; border-radius: 14px; cursor:pointer; font-weight:600; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .ok { color:#0a7; font-weight:700; }
    .bad { color:#b00; font-weight:700; }
    .muted { color:#666; font-size: 13px; }
    .big { font-size: 34px; font-weight: 800; margin: 6px 0; }
    .link { color:#06c; text-decoration: underline; cursor:pointer; }
    .details { display:none; white-space: pre-wrap; background:#fafafa; border:1px solid #eee; padding: 12px; border-radius: 12px; margin-top: 10px; font-size: 13px; }
    .right { margin-left:auto; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>rPPG Demo</h1>
  <div class="sub">Upload a face/palm video → Analyze → get HR + SpO₂ trend index and download CSV.</div>

  <div class="card">
    <div class="row">
      <div style="min-width:320px;">
        <label>Method</label>
        <select id="method">
          <option value="thesis_precomputed">Thesis (precomputed)</option>
          <option value="fft">Real pipeline (FFT + SpO₂ trend)</option>
          <option value="ceemdan_hilbert">Thesis-like (CEEMDAN + Hilbert, run on upload)</option>
        </select>
      </div>

      <div class="muted" id="methodHint" style="flex:1;">
        Uses thesis CSVs by Subject/Condition/Modality (no upload required).
      </div>

      <button class="btn right" type="button" id="settingsBtn">Settings</button>
    </div>

    <div class="row" id="fileRow">
      <div style="min-width:340px;">
        <label>Video</label>
        <input id="video" type="file" accept=".mp4,.mov,.avi,.mkv,.webm"/>
      </div>
      <div class="muted" id="fileHint">
        For <b>upload methods</b>, video is required. For <b>Thesis</b>, video is ignored.
      </div>
    </div>

    <div class="row">
      <div>
        <label>Subject</label>
        <input id="subject" value="S01" style="width:120px;">
      </div>
      <div>
        <label>Condition</label>
        <select id="condition">
          <option value="rest">rest</option>
          <option value="breath">breath</option>
          <option value="exercise">exercise</option>
        </select>
      </div>
      <div>
        <label>Modality</label>
        <select id="modality">
          <option value="face">face</option>
          <option value="palm">palm</option>
        </select>
      </div>
      <div>
        <label>Min valid %</label>
        <input id="minvalid" value="50" style="width:90px;">
      </div>
    </div>

    <div class="row">
      <button class="btn" id="analyzeBtn" type="button">Analyze</button>
      <div id="status" class="muted"></div>
    </div>
  </div>

  <div class="card" id="resultCard" style="display:none;">
    <div class="muted">Result</div>
    <div id="stem" class="muted" style="margin-top:6px;"></div>

    <div class="big" id="hrLine">HR: —</div>
    <div class="muted" id="hrQuality"></div>

    <div class="big" id="spo2Line">SpO₂ trend index: —</div>
    <div class="muted" id="spo2Quality"></div>

    <div class="row" style="margin-top:14px;">
      <a id="downloadLink" class="link" href="#" target="_blank" rel="noopener">Download CSV</a>
      <button class="btn" id="toggleBtn" type="button" style="background:#fff;color:#111;border:1px solid #ccc;">Show details</button>
    </div>

    <div class="details" id="details"></div>

    <div class="muted" style="margin-top:12px;">
      Note: On Render free tier, the service may sleep; first request can take ~30–60s. CEEMDAN+Hilbert may timeout for some videos.
    </div>
  </div>
</div>

<script>
  const methodEl = document.getElementById("method");
  const methodHint = document.getElementById("methodHint");
  const videoEl = document.getElementById("video");
  const analyzeBtn = document.getElementById("analyzeBtn");
  const statusEl = document.getElementById("status");

  const resultCard = document.getElementById("resultCard");
  const stemEl = document.getElementById("stem");
  const hrLine = document.getElementById("hrLine");
  const spo2Line = document.getElementById("spo2Line");
  const hrQuality = document.getElementById("hrQuality");
  const spo2Quality = document.getElementById("spo2Quality");
  const detailsEl = document.getElementById("details");
  const toggleBtn = document.getElementById("toggleBtn");
  const downloadLink = document.getElementById("downloadLink");

  function setHint() {
    const m = methodEl.value;
    if (m === "thesis_precomputed") {
      methodHint.textContent = "Uses thesis CSVs by Subject/Condition/Modality (no upload required).";
    } else if (m === "fft") {
      methodHint.textContent = "Runs a fast upload pipeline (FFT HR + SpO₂ trend index). Upload required.";
    } else {
      methodHint.textContent = "Runs thesis-like CEEMDAN + Hilbert on the uploaded video (may be slower). Upload required.";
    }
  }

  methodEl.addEventListener("change", setHint);
  setHint();

  toggleBtn.addEventListener("click", () => {
    const open = detailsEl.style.display === "block";
    detailsEl.style.display = open ? "none" : "block";
    toggleBtn.textContent = open ? "Show details" : "Hide details";
  });

  function fmt(x, digits=1) {
    if (x === null || x === undefined || Number.isNaN(x)) return "—";
    return Number(x).toFixed(digits);
  }

  async function run() {
    statusEl.textContent = "Working…";
    analyzeBtn.disabled = true;
    resultCard.style.display = "none";
    detailsEl.style.display = "none";
    toggleBtn.textContent = "Show details";

    const subject = document.getElementById("subject").value.trim() || "S01";
    const condition = document.getElementById("condition").value;
    const modality = document.getElementById("modality").value;
    const minvalid = document.getElementById("minvalid").value.trim() || "50";
    const method = methodEl.value;

    const fd = new FormData();
    fd.append("subject_id", subject);
    fd.append("condition", condition);
    fd.append("modality", modality);
    fd.append("method", method);
    fd.append("min_valid_pct", minvalid);

    // file required for upload methods
    if (method !== "thesis_precomputed") {
      if (!videoEl.files || videoEl.files.length === 0) {
        statusEl.textContent = "Please choose a video file for upload methods (FFT / CEEMDAN+Hilbert).";
        analyzeBtn.disabled = false;
        return;
      }
      fd.append("file", videoEl.files[0]);
    }

    try {
      const res = await fetch(`/upload_video`, { method: "POST", body: fd });
      const data = await res.json();

      if (!res.ok || !data.ok) {
        statusEl.textContent = "Error: " + (data.error || ("HTTP " + res.status));
        analyzeBtn.disabled = false;
        return;
      }

      const stem = data.stem || `${subject}_${condition}_${modality}`;
      stemEl.textContent = `Stem: ${stem}`;

      const hr = data.hr_bpm;
      const trusted = data.trusted;
      const spo2 = data.spo2_pct;
      const spo2Trusted = data.spo2_trusted;

      hrLine.textContent = `HR: ${fmt(hr, 1)} bpm`;
      hrQuality.innerHTML = `HR Quality: ${trusted ? '<span class="ok">Good</span>' : '<span class="bad">Low</span>'}`;

      spo2Line.textContent = `SpO₂ trend index: ${fmt(spo2, 1)} %`;
      spo2Quality.innerHTML = `SpO₂ Quality: ${spo2Trusted ? '<span class="ok">Good</span>' : '<span class="bad">Low</span>'}`;

      const dl = data.saved && data.saved.download_url ? data.saved.download_url : "#";
      downloadLink.href = dl;

      detailsEl.textContent = JSON.stringify(data, null, 2);
      resultCard.style.display = "block";
      statusEl.textContent = "Done.";
    } catch (e) {
      statusEl.textContent = "Error: " + e;
    } finally {
      analyzeBtn.disabled = false;
    }
  }

  analyzeBtn.addEventListener("click", run);
</script>
</body>
</html>
