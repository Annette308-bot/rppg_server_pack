<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>rPPG Demo</title>
  <style>
    body { font-family: Arial, sans-serif; background:#fff; color:#111; }
    .wrap { max-width: 920px; margin: 40px auto; padding: 0 16px; }
    h1 { font-size: 28px; margin: 0 0 8px; text-align:center; }
    .sub { text-align:center; color:#444; margin-bottom: 24px; }

    .card { border: 1px solid #ddd; border-radius: 18px; padding: 22px; margin: 14px 0; }
    .row { display:flex; gap:14px; flex-wrap:wrap; align-items:center; margin: 12px 0; }
    label { font-size: 13px; color:#333; display:block; margin-bottom:6px; }
    input, select { padding: 10px 12px; border-radius: 12px; border: 1px solid #ccc; font-size: 14px; }
    input[type="file"]{ padding: 8px; }

    .btn { background:#111; color:#fff; border:none; padding: 12px 18px; border-radius: 14px; cursor:pointer; font-weight:600; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }

    .ok { color:#0a7; font-weight:700; }
    .bad { color:#b00; font-weight:700; }
    .muted { color:#666; font-size: 13px; }
    .big { font-size: 34px; font-weight: 800; margin: 6px 0; }
    .link { color:#06c; text-decoration: underline; cursor:pointer; }

    .details { display:none; white-space: pre-wrap; background:#fafafa; border:1px solid #eee; padding: 12px; border-radius: 12px; margin-top: 10px; font-size: 13px; }
    .right { margin-left:auto; }

    .hint { color:#555; font-size: 13px; line-height: 1.4; }
    .modeTag { display:inline-block; margin-left:8px; padding: 2px 10px; border:1px solid #ddd; border-radius:999px; font-size: 12px; color:#333; background:#fafafa; }
    .fileDisabled { opacity: 0.55; }
    .warn { color:#b00; font-weight:700; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>rPPG Demo</h1>
  <div class="sub">Upload a face/palm video → Analyze → get HR + SpO₂ trend index and download a tiny CSV.</div>

  <div class="card">
    <div class="row">
      <div style="min-width:280px;">
        <label>Method</label>
        <select id="method">
          <option value="thesis_precomputed">Thesis (precomputed)</option>
          <option value="fft">Real pipeline (run on upload)</option>
        </select>
      </div>
      <div class="hint" id="methodHint" style="flex:1;">
        Uses thesis CSVs by Subject/Condition/Modality (no upload required).
      </div>
      <button class="btn right" type="button" id="settingsBtn">API Docs</button>
    </div>

    <div class="row" id="fileRow">
      <div style="min-width:320px;">
        <label>Video</label>
        <input id="video" type="file" accept=".mp4,.mov,.avi,.mkv,.webm"/>
      </div>
      <div class="hint" id="fileHint">
        For <b>Real pipeline</b>, video is required. For <b>Thesis</b>, video is ignored.
      </div>
    </div>

    <div class="row">
      <div>
        <label>Subject</label>
        <input id="subject" value="S01" style="width:120px;">
      </div>
      <div>
        <label>Condition</label>
        <select id="condition">
          <option value="rest">rest</option>
          <option value="breath">breath</option>
          <option value="exercise">exercise</option>
        </select>
      </div>
      <div>
        <label>Modality</label>
        <select id="modality">
          <option value="face">face</option>
          <option value="palm">palm</option>
        </select>
      </div>
      <div>
        <label>Min valid %</label>
        <input id="minvalid" value="50" style="width:90px;">
      </div>
    </div>

    <div class="row">
      <button class="btn" id="analyzeBtn" type="button">Analyze</button>
      <div id="status" class="muted"></div>
    </div>
  </div>

  <div class="card" id="resultCard" style="display:none;">
    <div class="muted">
      Result
      <span class="modeTag" id="modeTag">Mode: —</span>
    </div>
    <div id="stem" class="muted" style="margin-top:6px;"></div>

    <div class="big" id="hrLine">HR: —</div>
    <div class="muted" id="hrQuality"></div>

    <div class="big" id="spo2Line">SpO₂: —</div>
    <div class="muted" id="spo2Quality"></div>

    <div class="row" style="margin-top:14px;">
      <a id="downloadLink" class="link" href="#" target="_blank" rel="noopener" style="display:none;">Download CSV</a>
      <button class="btn" id="toggleBtn" type="button" style="background:#fff;color:#111;border:1px solid #ccc;">Show details</button>
    </div>

    <div class="details" id="details"></div>
    <div class="muted" style="margin-top:12px;">
      Note: On Render free tier, the service may sleep; first request can take ~30–60s.
    </div>
  </div>
</div>

<script>
  const methodEl = document.getElementById("method");
  const methodHint = document.getElementById("methodHint");
  const fileRow = document.getElementById("fileRow");
  const fileHint = document.getElementById("fileHint");
  const videoEl = document.getElementById("video");
  const analyzeBtn = document.getElementById("analyzeBtn");
  const statusEl = document.getElementById("status");

  const resultCard = document.getElementById("resultCard");
  const modeTag = document.getElementById("modeTag");
  const stemEl = document.getElementById("stem");
  const hrLine = document.getElementById("hrLine");
  const spo2Line = document.getElementById("spo2Line");
  const hrQuality = document.getElementById("hrQuality");
  const spo2Quality = document.getElementById("spo2Quality");
  const detailsEl = document.getElementById("details");
  const toggleBtn = document.getElementById("toggleBtn");
  const downloadLink = document.getElementById("downloadLink");
  const settingsBtn = document.getElementById("settingsBtn");

  function setUIByMethod() {
    const m = methodEl.value;

    // reset status
    statusEl.textContent = "";

    if (m === "thesis_precomputed") {
      methodHint.textContent = "Uses thesis CSVs by Subject/Condition/Modality (no upload required).";
      fileHint.innerHTML = "Thesis mode: <b>video is ignored</b> (you can leave it empty).";
      videoEl.disabled = true;
      videoEl.classList.add("fileDisabled");
      fileRow.classList.add("fileDisabled");
    } else {
      methodHint.textContent = "Runs the real pipeline script on the uploaded video (upload is required).";
      fileHint.innerHTML = "Real pipeline mode: <b>video is required</b>.";
      videoEl.disabled = false;
      videoEl.classList.remove("fileDisabled");
      fileRow.classList.remove("fileDisabled");
    }
  }

  methodEl.addEventListener("change", setUIByMethod);
  setUIByMethod();

  settingsBtn.addEventListener("click", () => {
    window.open("/docs", "_blank");
  });

  toggleBtn.addEventListener("click", () => {
    const open = detailsEl.style.display === "block";
    detailsEl.style.display = open ? "none" : "block";
    toggleBtn.textContent = open ? "Show details" : "Hide details";
  });

  function fmt(x, digits=1) {
    if (x === null || x === undefined || Number.isNaN(Number(x))) return "—";
    return Number(x).toFixed(digits);
  }

  function qualBadge(ok) {
    return ok ? '<span class="ok">Good</span>' : '<span class="bad">Low</span>';
  }

  async function run() {
    statusEl.textContent = "Working…";
    analyzeBtn.disabled = true;

    resultCard.style.display = "none";
    detailsEl.style.display = "none";
    toggleBtn.textContent = "Show details";
    downloadLink.style.display = "none";
    downloadLink.href = "#";

    const subject = (document.getElementById("subject").value || "S01").trim() || "S01";
    const condition = document.getElementById("condition").value;
    const modality = document.getElementById("modality").value;
    const minvalid = (document.getElementById("minvalid").value || "50").trim() || "50";
    const method = methodEl.value;

    // Real pipeline requires a file
    if (method !== "thesis_precomputed") {
      if (!videoEl.files || videoEl.files.length === 0) {
        statusEl.innerHTML = '<span class="warn">Please choose a video file for Real pipeline.</span>';
        analyzeBtn.disabled = false;
        return;
      }
    }

    const fd = new FormData();
    fd.append("subject_id", subject);
    fd.append("condition", condition);
    fd.append("modality", modality);
    fd.append("method", method);
    fd.append("min_valid_pct", minvalid);

    if (method !== "thesis_precomputed") {
      fd.append("file", videoEl.files[0]);
    }

    try {
      const res = await fetch("/upload_video", { method: "POST", body: fd });
      const data = await res.json().catch(() => ({}));

      if (!res.ok || !data.ok) {
        const err = data.error || ("HTTP " + res.status);
        statusEl.innerHTML = '<span class="warn">Error:</span> ' + String(err);
        detailsEl.textContent = JSON.stringify(data, null, 2);
        resultCard.style.display = "block";
        modeTag.textContent = "Mode: " + (method === "thesis_precomputed" ? "Thesis (precomputed)" : "Real pipeline");
        stemEl.textContent = "Stem: " + (data.stem || `${subject}_${condition}_${modality}`);
        hrLine.textContent = "HR: —";
        spo2Line.textContent = "SpO₂: —";
        hrQuality.textContent = "";
        spo2Quality.textContent = "";
        analyzeBtn.disabled = false;
        return;
      }

      // Mode display
      modeTag.textContent = "Mode: " + (data.method === "thesis_precomputed" ? "Thesis (precomputed)" : "Real pipeline");

      const stem = data.stem || `${subject}_${condition}_${modality}`;
      stemEl.textContent = `Stem: ${stem}`;

      const hr = data.hr_bpm;
      const trusted = !!data.trusted;

      const spo2 = data.spo2_pct;
      const spo2Trusted = !!data.spo2_trusted;

      hrLine.textContent = `HR: ${fmt(hr, 1)} bpm`;
      hrQuality.innerHTML = `HR Quality: ${qualBadge(trusted)}`;

      // SpO2 is a trend index, not clinical SpO2 (but show anyway)
      spo2Line.textContent = `SpO₂: ${fmt(spo2, 1)} %`;
      spo2Quality.innerHTML = `SpO₂ Quality: ${qualBadge(spo2Trusted)}`;

      // Download URL
      const dl = data.saved && data.saved.download_url ? data.saved.download_url : null;
      if (dl) {
        downloadLink.href = dl;
        downloadLink.style.display = "inline-block";
      }

      detailsEl.textContent = JSON.stringify(data, null, 2);
      resultCard.style.display = "block";
      statusEl.textContent = "Done.";
    } catch (e) {
      statusEl.innerHTML = '<span class="warn">Error:</span> ' + String(e);
    } finally {
      analyzeBtn.disabled = false;
    }
  }

  analyzeBtn.addEventListener("click", run);
</script>
</body>
</html>
